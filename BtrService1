import {  SPFI } from "@pnp/sp";
import "@pnp/sp/webs";
import "@pnp/sp/lists";
import "@pnp/sp/items";
import "@pnp/sp/attachments";
import "@pnp/sp/fields";

export default class BtrService {
  private readonly listTitle = "BTR";
  private readonly sp: SPFI;
  properties: any;

  constructor(sp: SPFI) {
    if (!sp) {
      throw new Error("SPFI instance is undefined");
    }
    this.sp = sp;
  }


  // CREATE ITEM + ATTACHMENTS (OPTIMIZED & SAFE)
  public async saveRequest(data: any, files: File[] = []): Promise<number> {
    console.log("üìå Creating list item", data);

    // 1Ô∏è‚É£ Create item
    console.log(data);
    const addResult = await this.sp.web.lists
      .getByTitle(this.listTitle)
      .items.add(data);

    // ‚úÖ Get Id safely
    debugger;
    const itemId = addResult.Id;
    console.log(`‚úÖ Item created with ID: ${itemId}`);

    // 2Ô∏è‚É£ Upload attachments
    if (files.length > 0) {
      for (const file of files) {
        try {
          // file is expected to be a File object from an <input type="file" />
          const buffer = await (file as File).arrayBuffer();
          await this.sp.web.lists
            .getByTitle("BTR")
            .items.getById(itemId)
            .attachmentFiles.add((file as File).name, buffer as any);
        } catch (err) {
          console.error(
            `Error uploading attachment ${
              (file as File).name
            } to item ${itemId}:`,
            err
          );
        }
      }
    } else {
      console.log("‚ÑπÔ∏è No attachments to upload");
    }

    return itemId;
  }


  // GET CHOICE FIELD VALUES (CACHED & SAFE)
  public async getChoiceFieldOptions(fieldName: string): Promise<string[]> {
    const field: any = await this.sp.web.lists
      .getByTitle(this.listTitle)
      .fields.getByInternalNameOrTitle(fieldName)();

    return field?.Choices ?? [];
  }

  // GET DISTINCT COUNTRIES FROM 'Cities' LIST (Title column holds country)
  public async getCountries(): Promise<string[]> {
    try {
      const items: any[] = await this.sp.web.lists
        .getByTitle("Cities")
        .items.select("Title")
        .top(5000)();

      const countries = (items || []).map((i) => i.Title).filter(Boolean);
      // unique
      return Array.from(new Set(countries));
    } catch (err) {
      console.error("Error loading Countries from Cities list:", err);
      return [];
    }
  }

  // GET CITIES FOR A GIVEN COUNTRY (City column = City)
  public async getCitiesByCountry(country: string): Promise<string[]> {
    if (!country) return [];
    try {
      // Escape single quotes for OData filter
      const safe = country.replace(/'/g, "''");
      const items: any[] = await this.sp.web.lists
        .getByTitle("Cities")
        .items.filter(`Title eq '${safe}'`)
        .select("City")
        .top(5000)();

      const cities = (items || []).map((i) => i.City).filter(Boolean);
      return Array.from(new Set(cities));
    } catch (err) {
      console.error(`Error loading cities for country ${country}:`, err);
      return [];
    }
  }

  // GET ITEM BY ID + ATTACHMENTS
  public async getTicketById(itemId: number): Promise<{ item?: any; attachments: Array<{ fileName: string; url?: string }> }> {
    try {
      const item: any = await this.sp.web.lists
        .getByTitle(this.listTitle)
        .items.getById(itemId)();

      // fetch attachments (if any)
      let attachments: Array<{ fileName: string; url?: string }> = [];
      try {
        const rawAttachments: any[] = await this.sp.web.lists
          .getByTitle(this.listTitle)
          .items.getById(itemId)
          .attachmentFiles();

        attachments = (rawAttachments || []).map((a: any) => ({
          fileName: a?.FileName || a?.Name || "",
          url: a?.ServerRelativeUrl || a?.serverRelativeUrl || a?.ServerUrl || undefined,
        }));
      } catch (attErr) {
        console.warn(`Unable to load attachments for item ${itemId}`, attErr);
      }

      return { item, attachments };
    } catch (err) {
      console.error(`Error loading item ${itemId} from list ${this.listTitle}:`, err);
      return { attachments: [] };
    }
  }




   

  
}
